
## Prepare source code
steps:
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', 'gs://$PROJECT_ID/credentials/builder/key.enc', './key.enc']
- name: 'gcr.io/cloud-builders/gsutil'
  args: ['cp', 'gs://$PROJECT_ID/credentials/builder/known_hosts', './known_hosts']

- name: 'gcr.io/cloud-builders/gcloud'
  args: 
    - kms
    - decrypt
    - --ciphertext-file=key.enc
    - --plaintext-file=/root/.ssh/id_rsa
    - --location=global
    - --keyring=builder-git
    - --key=github
  volumes:
  - name: 'ssh'
    path: /root/.ssh
# Set up git with key and domain.
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    chmod 600 /root/.ssh/id_rsa
    cat <<EOF >/root/.ssh/config
    Hostname github.com
    IdentityFile /root/.ssh/id_rsa
    EOF
    mv known_hosts /root/.ssh/known_hosts
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- name: 'gcr.io/cloud-builders/git'
  args:
  - clone
  - git@github.com:catcatio/shio.git
  volumes:
  - name: 'ssh'
    path: /root/.ssh

- name: 'gcr.io/cloud-builders/git'
  dir: shio
  args:
  - checkout
  - develop


#### YARN INSTALL
- name: 'mhart/alpine-node:10'
  dir: 'shio'
  env:
  - 'YARN_CACHE_FOLDER=/workspace/.yarn-cache'
  args:
  - yarn
  - install

- name: 'alpine'
  args:
  - tar
  - -cpzf
  - 'yarn-cache.tar.gz'
  - -C
  - '/'
  - 'workspace/.yarn-cache'

- name: 'gcr.io/cloud-builders/gsutil'
  args:
    - cp
    - yarn-cache.tar.gz
    - gs://$PROJECT_ID/.cache/yarn-cache.tar.gz
